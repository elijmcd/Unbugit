@model IEnumerable<Unbugit.Models.Ticket>
@using Microsoft.AspNetCore.Identity
@inject UserManager<BTUser> btUserManager

@{
    ViewData["Title"] = "MyTickets";
    BTUser btUser = await btUserManager.GetUserAsync(User);
}


<div class="table-responsive">
    <h3>@btUser.FirstName's Developer Tickets</h3>
@*@if (User.IsInRole("Admin") || User.IsInRole("ProjectManager"))
{
    <p>
        <a class="btn btn-gradient-primary" asp-action="Create">Create New</a>
    </p>
}*@
    <table id="myTable" class="table table-hover">
        <caption>Developer tickets for @btUser.FullName</caption>
        <thead>
            <tr>
                <th>
                    Title
                </th>
                <th>
                    Created / Updated
                </th>
                @*<th>
                    Archive
                </th>*@
                <th>
                    Project
                </th>
                <th>
                    Type
                </th>
                <th>
                    Priority
                </th>
                <th>
                    Status
                </th>
                <th>
                    Owner
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Where(t => t.DeveloperUserId == btUser.Id))
            {
                <tr>
                    <td>
                        <a asp-action="Details" asp-controller="Tickets" asp-route-id="@item.Id">
                            @item.Title
                        </a>

                    </td>
                    @if (item.Updated is null)
                    {
                        <td>
                            @item.Created.ToString("D")
                        </td>
                    }
                    else
                    {
                        <td>
                            @item.Updated?.ToString("D")
                        </td>
                    }
                    @*@if (!item.Archived)
                    {
                        <td>
                            @Html.DisplayFor(modelItem => item.Archived)
                        </td>
                    }
                    else
                    {
                        <td>
                            @Html.DisplayFor(modelItem => item.ArchivedDate)
                        </td>
                    }*@
                    <td>
                        @item.Project.Name
                    </td>
                    <td>
                        @item.TicketType.Name
                    </td>
                    <td>
                        @item.TicketPriority.Name
                    </td>
                    <td>
                        @item.TicketStatus.Name
                    </td>
                    <td>
                        @item.OwnerUser?.FullName
                    </td>
                    <td>
                        <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                        <a asp-action="Details" asp-route-id="@item.Id">Details</a> |
                        <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
<br />
<hr style="border:dotted; border-radius:75%; border-color:#22DC0A; max-width:50%; opacity:.8;" />
<br />
<div class="table-responsive">
    <h3>@btUser.FirstName's Submitted Tickets</h3>
    @if (User.IsInRole("Admin") || User.IsInRole("ProjectManager") || User.IsInRole("Submitter"))
    {
        <p>
            <a class="btn btn-gradient-primary" asp-action="Create">Add Ticket</a>
        </p>
    }

    <table id="myTable2" class="table table-hover">
        <caption>Submitted Tickets for @btUser.FullName</caption>
        <thead>
            <tr>
                <th>
                    Title
                </th>
                <th>
                    Created / Updated
                </th>
                @*<th>
                    Archive
                </th>*@
                <th>
                    Project
                </th>
                <th>
                    Type
                </th>
                <th>
                    Priority
                </th>
                <th>
                    Status
                </th>
                <th>
                    Developer
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Where(t => t.OwnerUserId == btUser.Id))
            {
            <tr>
                <td>
                    <a class="btn btn-outline-info btn-small" asp-action="Details" asp-controller="Tickets" asp-route-id="@item.Id">
                        @item.Title
                    </a>
                </td>
                @if (item.Updated is null)
                {
                    <td>
                        @item.Created.ToString("D")
                    </td>
                }
                else
                {
                    <td>
                        @item.Updated?.ToString("D")
                    </td>
                }
                @*@if (!item.Archived)
                {
                    <td>
                        @Html.DisplayFor(modelItem => item.Archived)
                    </td>
                }
                else
                {
                    <td>
                        @Html.DisplayFor(modelItem => item.ArchivedDate)
                    </td>
                }*@
                <td>
                    @item.Project.Name
                </td>
                <td>
                    @item.TicketType.Name
                </td>
                <td>
                @if (item.TicketPriorityId == 1)
                {
                    <span class="badge badge-danger">@item.TicketPriority.Name</span>
                }
                else if (item.TicketPriorityId == 2)
                {
                    <span class="badge badge-warning">@item.TicketPriority.Name</span>
                }
                else if (item.TicketPriorityId == 3)
                {
                    <span class="badge badge-info">@item.TicketPriority.Name</span>
                }
                else if (item.TicketPriorityId == 4)
                {
                    <span class="badge badge-primary">@item.TicketPriority.Name</span>
                }
                </td>
                <td>
                    @item.TicketStatus.Name
                </td>
                <td>
                @if(item.DeveloperUser is not null)
                {
                    @item.DeveloperUser?.FullName
                }
                else
                {
                    <a class="text-center text-danger" asp-action="AssignTicket" asp-controller="Tickets" asp-route-ticketId="@item.Id">Not Assigned</a>
                }
                </td>

                <td>
                    <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                    @*<a asp-action="Details" asp-route-id="@item.Id">Details</a> |*@
                    <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                </td>
            </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts{
    <script>
        $(document).ready(function () {
            $('#myTable').DataTable();
        });
    </script>
    <script>
        $(document).ready(function () {
            $('#myTable2').DataTable();
        });
    </script>
}