@model IEnumerable<Unbugit.Models.Ticket>
@using Microsoft.AspNetCore.Identity
@using Unbugit.Services.Interfaces
@using Unbugit.Extensions

@inject IBTCompanyInfoService CompanyInfoService
@inject IBTRoleService RolesService
@inject IBTTicketService TicketService
@inject IBTProjectService ProjectService
@inject IBTFileService FileService
@inject UserManager<BTUser> UserManager

@{
    BTUser btUser = await UserManager.GetUserAsync(User);
    ViewData["Title"] = "All Tickets";
}

<h1>All Tickets</h1>

<div class="row sort">
    @foreach (var item in Model)
    {
        <div class="col-lg-3 col-md-6 col-sm-12 my-1">

            <div class="card shadow p-2" style="border: 1px solid #DD44A7">
                <dl class="text-center bg-success-bright text-success">
                    @item.Project.Name
                </dl>
                @if ((item.OwnerUserId == btUser.Id) ||
                    (item.DeveloperUserId == btUser.Id) ||
                    (await ProjectService.GetProjectManagerAsync(item.ProjectId) == btUser))
                {
                    <a asp-action="Details" asp-controller="Tickets" asp-route-id="@item.Id">
                        <h5 class="text-center bg-secondary-bright text-secondary py-3">@item.Title</h5>
                    </a>
                }
                else
                {
                    <a asp-action="Details" asp-controller="Tickets" asp-route-id="@item.Id">
                        <h5 class="text-center text-muted py-3" style="border: 1px solid #DD44A7">@item.Title</h5>
                    </a>
                }
                <dl class="text-light">
                    Ticket Priority
                </dl>
                <dd>
                    @if (item.TicketPriorityId == 1)
                    {
                        <span class="badge badge-danger text-danger bg-danger-bright">@item.TicketPriority.Name</span>
                    }
                    else if (item.TicketPriorityId == 2)
                    {
                        <span class="badge badge-warning text-warning bg-warning-bright">@item.TicketPriority.Name</span>
                    }
                    else if (item.TicketPriorityId == 3)
                    {
                        <span class="badge badge-info text-info bg-info-bright">@item.TicketPriority.Name</span>
                    }
                    else if (item.TicketPriorityId == 4)
                    {
                        <span class="badge badge-primary text-primary bg-primary-bright">@item.TicketPriority.Name</span>
                    }
                </dd>
                <dl class="text-light">
                    Created
                </dl>
                <dd>
                    @item.Created.ToString("d")
                </dd>
                <dl class="text-light">
                    Owner
                </dl>
                <dd>
                    <figure class="avatar" title="@item.OwnerUser.FullName">
                        <img src="@FileService.ConvertByteArrayToFile(item.OwnerUser.AvatarFileData, item.OwnerUser.AvatarContentType)" class="rounded-circle" alt="@item.OwnerUser.FullName">
                    </figure>
                    @item.OwnerUser.FullName
                </dd>
                <dl class="text-light">
                    Developer
                </dl>
                <dd>
                    @if (item.DeveloperUser != null)
                    {
                        <figure class="avatar" title="@item.DeveloperUser?.FullName">
                            <img src="@FileService.ConvertByteArrayToFile(item.DeveloperUser.AvatarFileData, item.DeveloperUser.AvatarContentType)" class="rounded-circle" alt="@item.DeveloperUser.FullName">
                        </figure>
                        @item.DeveloperUser?.FullName
                    }
                    else
                    {
                        <p>No Developer Assigned</p>
                    }
                </dd>
            </div>
        </div>
    }
</div>

@*<p>
        <a asp-action="Create">Create New</a>
    </p>
    <table class="dataTable">
        <thead>
            <tr>
                <th>
                    Title
                </th>
                <th>
                    Description
                </th>
                <th>
                    Created
                </th>
                <th>
                    Updated
                </th>
                <th>
                    Archived
                </th>
                <th>
                    Project
                </th>
                <th>
                    Type
                </th>
                <th>
                    Priority
                </th>
                <th>
                    Status
                </th>
                <th>
                    Owner
                </th>
                <th>
                    Developer
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>
                        @Html.DisplayFor(modelItem => item.Title)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Description)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Created)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Updated)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.ArchivedDate)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Archived)
                    </td>
                    <td>
                        @Html.DisplayFor(modelItem => item.Project.Name)
                    </td>
                    <td>
                        @item.TicketType.Id
                    </td>
                    <td>
                        @item.TicketPriority.Name
                    </td>
                    <td>
                        @item.TicketStatus.Name
                    </td>
                    <td>
                        @item.OwnerUser?.FullName
                    </td>
                    <td>
                        @item.DeveloperUser?.FullName
                    </td>
                    <td>
                        <a asp-action="Edit" asp-route-id="@item.Id">Edit</a> |
                        <a asp-action="Details" asp-route-id="@item.Id">Details</a> |
                        <a asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    }*@
@*else
    {
        <h3>Sorry, you do not have access to this resource.</h3>
        <a asp-action="Dashboard" asp-controller="Home" asp-route-id="@btUser.Id"><p>Return Home</p></a>
    }*@