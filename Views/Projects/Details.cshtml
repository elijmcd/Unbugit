@model Unbugit.Models.Project

@using Unbugit.Services.Interfaces
@using Microsoft.AspNetCore.Identity
@using Unbugit.Extensions

@inject IBTCompanyInfoService CompanyInfoService
@inject IBTRoleService RoleService
@inject IBTTicketService TicketService
@inject IBTProjectService ProjectService
@inject UserManager<BTUser> UserManager

@{
    List<BTUser> developers = await ProjectService.GetProjectMembersByRoleAsync(Model.Id, "Developer");
    List<BTUser> submitters = await ProjectService.GetProjectMembersByRoleAsync(Model.Id, "Submitter");
    BTUser projectManager = await ProjectService.GetProjectManagerAsync(Model.Id);
    ViewData["Title"] = "Project Details";
}

<h3>@Model.Company.Name</h3>
<hr />
<h4>@Model.Name</h4>
<div>
    <hr />
    <div class="row">
        <div class="col-10 offset-1 card shadow bg-dark-gradient border-success p-3">
            <div class="row">
                <div class="col">
                    <dl>
                        <dd class="col-sm-6">
                            <em>@Model.Description</em>
                        </dd>
                        <dt class="col-sm-6">
                            @Html.DisplayNameFor(model => model.StartDate)
                        </dt>
                        <dd class="col-sm-6">
                            @Model.StartDate.ToString("d")
                        </dd>
                        <dt class="col-sm-6">
                            @Html.DisplayNameFor(model => model.EndDate)
                        </dt>
                        <dd class="col-sm-6">
                            @Model.EndDate?.ToString("d")
                        </dd>
                        <dt class="col-sm-6">
                            Priority
                        </dt>
                        <dd class="col-sm-6">
                            @if (Model.ProjectPriorityId == 1)
                            {
                                <span class="text-danger">@Model.ProjectPriority.Name</span>
                            }
                            else if (Model.ProjectPriorityId == 2)
                            {
                                <span class="text-warning">@Model.ProjectPriority.Name</span>
                            }
                            else if (Model.ProjectPriorityId == 3)
                            {
                                <span class="text-info">@Model.ProjectPriority.Name</span>
                            }
                            else if (Model.ProjectPriorityId == 4)
                            {
                                <span class="text-primary">@Model.ProjectPriority.Name</span>
                            }
                        </dd>
                        <dd class="col-10">
                            Project Manager:
                            <ul>
                                @if ((projectManager != null) && (User.IsInRole("Admin")))
                                {
                                    <a class="btn btn-outline-warning" asp-action="AssignPM" asp-controller="Projects" asp-route-id="@Model.Id">
                                        <li>@projectManager.FullName</li>
                                    </a>
                                }
                                else if (User.IsInRole("Admin"))
                                {
                                    <a class="btn btn-outline-warning" asp-action="AssignPM" asp-controller="Projects" asp-route-id="@Model.Id">No Project Manager Assigned</a>
                                }
                                else
                                {
                                    <li>No Project Manager Assigned</li>
                                }
                            </ul>
                        </dd>
                    </dl>
                    <br />
                    <hr style="border:dotted; border-radius:75%; border-color:#22DC0A; max-width:50%;" />
                    <br />
                </div>
            </div>
            <div class="row">
                <div class="col-4">
                    <dl>
                        <dt class="text-info">
                            Developers:
                        </dt>
                        <dd>
                            <ul>
                                @foreach (var member in developers)
                                {
                                    <li>@member.FullName</li>
                                }
                            </ul>
                        </dd>
                    </dl>
                </div>
                <div class="col-4">
                    <dl>
                        <dt class="text-secondary">
                            Submitters:
                        </dt>
                        <dd>
                            <ul>
                                @foreach (var member in submitters)
                                {
                                    <li>@member.FullName</li>
                                }
                            </ul>
                        </dd>
                    </dl>
                </div>
                <div class="col-4">
                    <a class="btn btn-outline-success" asp-action="AssignUsers" asp-controller="Projects" asp-route-id="@Model.Id">Manage Users on Project</a>
                </div>
            </div>
        </div>
    </div>
</div>
<br />

@*<dt class = "col-sm-2">
        @Html.DisplayNameFor(model => model.ImageFileName)
    </dt>
    <dd class = "col-sm-10">
        @Html.DisplayFor(model => model.ImageFileName)
    </dd>
    <dt class = "col-sm-2">
        @Html.DisplayNameFor(model => model.ImageFileData)
    </dt>
    <dd class = "col-sm-10">
        @Html.DisplayFor(model => model.ImageFileData)
    </dd>
    <dt class = "col-sm-2">
        @Html.DisplayNameFor(model => model.ImageContentType)
    </dt>
    <dd class = "col-sm-10">
        @Html.DisplayFor(model => model.ImageContentType)
    </dd>
    <dt class = "col-sm-2">
        @Html.DisplayNameFor(model => model.Archived)
    </dt>
    <dd class = "col-sm-10">
        @Html.DisplayFor(model => model.Archived)
    </dd>*@

<div class="table-responsive">
    <h3>Project Tickets:</h3>
    <table id="myTable" class="table table-hover">
        <caption>Tickets for @Model.Name</caption>
        <thead>
            <tr>
                <th>
                    Title
                </th>
                <th>
                    Description
                </th>
                <th>
                    Created
                </th>
                <th>
                    Submitter
                </th>
                <th>
                    Developer
                </th>
                <th>
                    Priority
                </th>
                <th>
                    Status
                </th>
                <th>
                    Type
                </th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (Ticket ticket in Model.Tickets)
            {
                <tr>

                    <td>
                        <a class="text-primary" asp-action="Details" asp-controller="Tickets" asp-route-id="@ticket.Id">
                            @ticket.Title
                        </a>
                    </td>
                    <td>
                        @ticket.Description
                    </td>
                    <td>
                        @ticket.Created.ToString("D")
                    </td>
                    <td>
                        @ticket.OwnerUser?.FullName
                    </td>
                    <td>
                        @ticket.DeveloperUser?.FullName
                    </td>
                    <td>
                        @if (ticket.TicketPriorityId == 1)
                        {
                            <span class="badge bg-danger-bright text-danger">@ticket.TicketPriority.Name</span>
                        }
                        else if (ticket.TicketPriorityId == 2)
                        {
                            <span class="badge bg-warning-bright text-warning">@ticket.TicketPriority.Name</span>
                        }
                        else if (ticket.TicketPriorityId == 3)
                        {
                            <span class="badge bg-primary-bright text-primary">@ticket.TicketPriority.Name</span>
                        }
                        else if (ticket.TicketPriorityId == 4)
                        {
                            <span class="badge bg-success-bright text-success">@ticket.TicketPriority.Name</span>
                        }
                    </td>
                    <td>
                        @ticket.TicketStatus
                    </td>
                    <td>
                        @ticket.TicketType
                    </td>
                    <td></td>
                </tr>
            }
        </tbody>
    </table>
    @*<a asp-action="Details" asp-controller="Tickets" asp-route-id="@ticket.Id">@ticket.Title</a>*@
</div>
<div>
    <a asp-action="Create" asp-controller=Tickets asp-route-id="@Model.Id">Create New Ticket</a> |
    <a asp-action="Edit" asp-route-id="@Model.Id">Edit</a> |
    <a asp-action="Index">Back to Project List</a>
</div>

@section Scripts{
    <script>
        $(document).ready(function () {
            $('#myTable').DataTable();
        });
    </script>
}